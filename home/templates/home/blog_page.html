{% extends "_base.html" %}
{% load wagtailcore_tags wagtailimages_tags static %}

{% block content %}
<article class="max-w-4xl mx-auto px-4 py-8">
    <!-- Blog Header -->
    <header class="mb-8">
        <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-2">{{ page.title }}</h1>
        
        <div class="flex flex-wrap items-center gap-4 text-gray-600 dark:text-gray-400">
            <div class="flex items-center">
                {% if page.owner.wagtail_userprofile.avatar %}
                {% image page.owner.wagtail_userprofile.avatar fill-40x40 as avatar %}
                <img src="{{ avatar.url }}" alt="{{ page.owner.username }}" 
                     class="w-10 h-10 rounded-full mr-3 object-cover">
                {% else %}
                <div class="w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center mr-3">
                    <span class="text-gray-600 dark:text-gray-300">{{ page.owner.username|first|upper }}</span>
                </div>
                {% endif %}
                <span class="font-medium">{{ page.owner.username }}</span>
            </div>
            <span class="hidden sm:inline">•</span>
            <span>{{ page.date|date:"F j, Y" }}</span>
            <span class="hidden sm:inline">•</span>
            <span>{{ page.reading_time }} min read</span>
        </div>
    </header>

    <!-- Featured Image -->
    {% if page.cover_image %}
    <div class="mb-8 rounded-lg overflow-hidden shadow-lg">
        {% image page.cover_image width-1000 format-webp as cover_img %}
        <img src="{{ cover_img.url }}" 
             alt="{{ cover_img.alt }}" 
             class="w-full h-auto object-cover"
             loading="lazy">
    </div>
    {% endif %}

    <!-- Blog Content -->
    <div class="prose dark:prose-invert prose-lg max-w-none mb-12">
        {{ page.body|richtext }}
    </div>

    <!-- Tags -->
    {% if page.tags.all %}
    <div class="flex flex-wrap gap-2 mb-8">
        {% for tag in page.tags.all %}
        <a href="{% slugurl 'tags' %}?tag={{ tag|urlencode }}" 
           class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition">
            {{ tag }}
        </a>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Like/Share Section -->
    <div class="border-t border-b border-gray-200 dark:border-gray-700 py-6 mb-8">
        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="flex items-center space-x-4 like-section">
                {% if request.user.is_authenticated %}
                <button class="flex items-center space-x-1 text-gray-600 dark:text-gray-400 hover:text-red-500 transition"
                        hx-post="{% url 'toggle_like' page.id %}"
                        hx-target=".like-section"
                        hx-swap="innerHTML"
                        _="on click toggle .text-red-500 on <i.fa-heart/> in me
                           then toggle .fas on <i.fa-heart/> in me
                           then toggle .far on <i.fa-heart/> in me">
                    <i class="{% if request.user in page.likes.all %}fas text-red-500{% else %}far{% endif %} fa-heart"></i>
                    <span class="like-count">{{ page.likes.count }}</span>
                </button>
                {% else %}
                <a href="{% url 'account_login' %}?next={{ request.path }}" class="flex items-center space-x-1 text-gray-600 dark:text-gray-400 hover:text-red-500 transition">
                    <i class="far fa-heart"></i>
                    <span>{{ page.likes.count }}</span>
                </a>
                {% endif %}
            </div>
            
            <div class="flex space-x-4">
                <button class="text-gray-600 dark:text-gray-400 hover:text-blue-500 transition"
                        onclick="window.open('https://twitter.com/intent/tweet?text=Check out this post: {{ page.title|urlencode }}&url={{ request.build_absolute_uri|urlencode }}', '_blank')"
                        aria-label="Share on Twitter">
                    <i class="fab fa-twitter"></i>
                </button>
                <button class="text-gray-600 dark:text-gray-400 hover:text-blue-700 transition"
                        onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&url={{ request.build_absolute_uri|urlencode }}&title={{ page.title|urlencode }}', '_blank')"
                        aria-label="Share on LinkedIn">
                    <i class="fab fa-linkedin"></i>
                </button>
                <button class="text-gray-600 dark:text-gray-400 hover:text-gray-800 transition copy-link"
                        _="on click writeText('{{ request.build_absolute_uri }}') to navigator.clipboard
                           then add .text-green-500 to me
                           then wait 2s
                           then remove .text-green-500 from me"
                        aria-label="Copy link">
                    <i class="fas fa-link"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Comments Section -->
    <div class="mb-12">
        <h2 class="text-2xl font-bold mb-6">Comments (<span id="comment-count">{{ page.post_comments.count }}</span>)</h2>
        
        {% if request.user.is_authenticated %}
        <form class="mb-8" id="comment-form"
              hx-post="{% url 'add_comment' page.id %}" 
              hx-target="#comments-list" 
              hx-swap="afterbegin"
              _="on htmx:afterRequest reset() me
                 on submit if my textarea.value.trim() is empty then preventDefault()">
            {% csrf_token %}
            <div class="flex gap-4">
                {% if request.user.profile.avatar %}
                {% image request.user.profile.avatar fill-40x40 as avatar %}
                <img src="{{ avatar.url }}" alt="{{ request.user.username }}" 
                     class="w-10 h-10 rounded-full object-cover">
                {% else %}
                <div class="w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center flex-shrink-0">
                    <span class="text-gray-600 dark:text-gray-300">{{ request.user.username|first|upper }}</span>
                </div>
                {% endif %}
                <div class="flex-1">
                    <textarea name="text" rows="3" 
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" 
                        placeholder="Add a comment..."
                        required></textarea>
                    <button type="submit" 
                        class="mt-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                        Post Comment
                    </button>
                </div>
            </div>
        </form>
        {% else %}
        <div class="text-center py-6 border border-gray-200 dark:border-gray-700 rounded-lg">
            <p class="mb-4">Want to join the discussion?</p>
            <a href="{% url 'account_login' %}?next={{ request.path }}" 
               class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                Log in to comment
            </a>
        </div>
        {% endif %}

        <div class="space-y-6" id="comments-list">
            {% for comment in page.post_comments.all %}
            <div class="flex gap-4">
                {% if comment.user.profile.avatar %}
                {% image comment.user.profile.avatar fill-40x40 as avatar %}
                <img src="{{ avatar.url }}" alt="{{ comment.user.username }}" 
                     class="w-10 h-10 rounded-full flex-shrink-0 object-cover">
                {% else %}
                <div class="w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center flex-shrink-0">
                    <span class="text-gray-600 dark:text-gray-300">{{ comment.user.username|first|upper }}</span>
                </div>
                {% endif %}
                <div class="flex-1">
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-2 gap-1">
                            <span class="font-bold">{{ comment.user.username }}</span>
                            <span class="text-sm text-gray-500">{{ comment.created_at|timesince }} ago</span>
                        </div>
                        <p class="text-gray-700 dark:text-gray-300">{{ comment.text }}</p>
                    </div>
                    <div class="flex items-center mt-2 space-x-4 text-sm">
                        {% if request.user.is_authenticated %}
                        <button class="flex items-center space-x-1 text-gray-500 hover:text-red-500 transition"
                                hx-post="{% url 'toggle_comment_like' comment.id %}"
                                hx-target="closest .flex-1"
                                hx-swap="outerHTML"
                                _="on click toggle .text-red-500 on <i.fa-heart/> in me
                                   then toggle .fas on <i.fa-heart/> in me
                                   then toggle .far on <i.fa-heart/> in me">
                            <i class="{% if request.user in comment.likes.all %}fas text-red-500{% else %}far{% endif %} fa-heart"></i>
                            <span>{{ comment.likes.count }}</span>
                        </button>
                        {% else %}
                        <a href="{% url 'account_login' %}?next={{ request.path }}" class="flex items-center space-x-1 text-gray-500 hover:text-red-500 transition">
                            <i class="far fa-heart"></i>
                            <span>{{ comment.likes.count }}</span>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% empty %}
            <p class="text-center text-gray-500 py-6">No comments yet. Be the first to comment!</p>
            {% endfor %}
        </div>
    </div>
</article>
{% endblock %}

{% block extra_css %}
<style>
    /* Improved prose styling */
    .prose {
        line-height: 1.75;
        color: inherit;
    }
    .prose p {
        margin-bottom: 1.5rem;
    }
    .prose h2 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-top: 2.5rem;
        margin-bottom: 1rem;
        line-height: 1.3;
    }
    .prose h3 {
        font-size: 1.25rem;
        font-weight: 600;
        margin-top: 2rem;
        margin-bottom: 1rem;
        line-height: 1.3;
    }
    .prose ul, .prose ol {
        margin-bottom: 1.5rem;
        padding-left: 1.5rem;
    }
    .prose li {
        margin-bottom: 0.5rem;
    }
    .prose li > p {
        margin-bottom: 0.5rem;
    }
    .prose blockquote {
        border-left: 4px solid #e5e7eb;
        padding-left: 1rem;
        font-style: italic;
        color: #6b7280;
        margin: 1.5rem 0;
    }
    .dark .prose blockquote {
        border-left-color: #4b5563;
        color: #9ca3af;
    }
    .prose pre {
        background-color: #f3f4f6;
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        margin: 1.5rem 0;
        font-size: 0.9rem;
    }
    .dark .prose pre {
        background-color: #1f2937;
    }
    .prose code {
        background-color: #f3f4f6;
        padding: 0.2rem 0.4rem;
        border-radius: 0.25rem;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.9em;
    }
    .dark .prose code {
        background-color: #1f2937;
    }
    .prose a {
        color: #3b82f6;
        text-decoration: underline;
        text-underline-offset: 2px;
    }
    .dark .prose a {
        color: #60a5fa;
    }
    .prose img {
        border-radius: 0.5rem;
        margin: 1.5rem auto;
    }
    
    /* Responsive adjustments */
    @media (max-width: 640px) {
        .prose {
            font-size: 1rem;
        }
        .prose h2 {
            font-size: 1.3rem;
        }
        .prose h3 {
            font-size: 1.15rem;
        }
    }
    
    /* Animation for likes */
    @keyframes ping {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.5); opacity: 0.5; }
        100% { transform: scale(1); opacity: 1; }
    }
    .animate-ping {
        animation: ping 0.5s cubic-bezier(0, 0, 0.2, 1);
    }
    
    /* Loading states */
    .htmx-request {
        opacity: 0.7;
        cursor: wait;
    }
    
    /* Copy link feedback */
    .text-green-500 {
        color: #10B981;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- Load HTMX from CDN -->
<script src="https://unpkg.com/htmx.org@1.9.6"></script>
<!-- Load Hyperscript from CDN -->
<script src="https://unpkg.com/hyperscript.org@0.9.11"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Fallback for copy link button
    document.querySelectorAll('.copy-link').forEach(button => {
        button.addEventListener('click', function() {
            navigator.clipboard.writeText('{{ request.build_absolute_uri }}')
                .then(() => {
                    const icon = this.querySelector('i');
                    icon.classList.add('text-green-500');
                    setTimeout(() => {
                        icon.classList.remove('text-green-500');
                    }, 2000);
                })
                .catch(err => {
                    console.error('Failed to copy text: ', err);
                });
        });
    });
    
    // Ensure HTMX requests include CSRF token
    document.body.addEventListener('htmx:configRequest', function(evt) {
        evt.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
    });
    
    // Initialize comment count update handler
    document.getElementById('comments-list')?.addEventListener('htmx:afterSwap', function() {
        const commentCount = parseInt(document.getElementById('comment-count').textContent.match(/\d+/)[0]);
        document.getElementById('comment-count').textContent = `Comments (${commentCount + 1})`;
    });
});
</script>
{% endblock %}